<template>
  <div class="container">
    <div class="chatRoom">
      <div v-if="roomVisible" class="background">
        <div class="banner">
          <div>
            <span>ID:888</span>
            <span>
              <font-awesome-icon icon="fa-solid fa-house-fire" />Âç≥Êó∂ËÅäÂ§©ÂÆ§
            </span>
            <span>
              <a @click="share">
                <font-awesome-icon icon="fa-solid fa-share" />ÂàÜ‰∫´
              </a>
            </span>
          </div>
          <div>
            <span>
              <a target="_blank" href="https://github.com/h-sina">
                <font-awesome-icon icon="fa-brands fa-github" />ÂºÄÊ∫êÂú∞ÂùÄ
              </a>
            </span>

            <span>
              <font-awesome-icon icon="fa-solid fa-people-roof" />
              Âú®Á∫ø[{{ persons }}]
            </span>

            <span>
              <a @click="() => { changeFull = false; fullScreen() }" v-show="changeFull">
                <font-awesome-icon icon="fa-solid fa-expand" />ÂÖ®Â±è
              </a>
              <a @click="() => { changeFull = true;smallScreen() }" v-show="!changeFull">
                <font-awesome-icon icon="fa-solid fa-compress" />Â∞èÂ±è
              </a>
            </span>
            <span>
              <a @click="close">
                <font-awesome-icon icon="fa-solid fa-arrow-right-from-bracket" />ÈÄÄÂá∫
              </a>
            </span>
          </div>
        </div>
        <div class="main">
          <div id="p"></div>
          <div class="textareaBanner">
            <span>
              <font-awesome-icon icon="fa-solid fa-image" />Ë°®ÊÉÖ
            </span>
            <span>
              <a @click="pickMusic">
                <font-awesome-icon icon="fa-solid fa-music" />ÁÇπÊ≠å
              </a>
            </span>
            <span>
              <font-awesome-icon icon="fa-solid fa-clapperboard" />ÁúãÁîµÂΩ±
            </span>
          </div>
          <textarea class="textarea" placeholder="ÂõûËΩ¶ÂèëÈÄÅ" @keyup.enter="send" v-model="msg"></textarea>
          <div id="lyric">Ê≠åËØçÊãºÂëΩÂä†ËΩΩ‰∏≠...</div>
        </div>
      </div>
      <div v-if="!roomVisible" style="width:100%;">
        <img
          @click="enteragain"
          style="height:100%;"
          src="../assets/6823b1a4d138ab0891471d76f4e74802.gif"
        />
      </div>
    </div>
    <el-dialog v-model="dialogVisible" title="ÂàÜ‰∫´Âà∞" width="30%">
      <div class="share">
        <a @click="shareToQQ(param)">
          <font-awesome-icon icon="fa-brands fa-qq" />QQ
        </a>
        <a @click="shareToWeChat(param)">
          <font-awesome-icon icon="fa-brands fa-weixin" />ÂæÆ‰ø°
        </a>
        <a @click="shareToWebo(param)">
          <font-awesome-icon icon="fa-brands fa-weibo" />ÂæÆÂçö
        </a>
      </div>
    </el-dialog>
    <el-dialog v-model="MdialogVisible" title="pick‰Ω†ÂñúÊ¨¢ÁöÑ" width="30%">
      <div class="share">
        <a @click="shareToQQ">
          <font-awesome-icon icon="fa-brands fa-qq" />QQ
        </a>
        <a @click="shareToWeChat">
          <font-awesome-icon icon="fa-brands fa-weixin" />ÂæÆ‰ø°
        </a>
        <a @click="shareToWebo">
          <font-awesome-icon icon="fa-brands fa-weibo" />ÂæÆÂçö
        </a>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import io from 'socket.io-client';
import { onMounted, ref, computed, reactive, onBeforeUnmount } from 'vue';
import { store } from '@/store/index';
import axios from 'axios';
import { musicList, GetDmusicList } from '@/music/index';
import { onBeforeRouteLeave } from 'vue-router';
import { useRouter } from 'vue-router';
import { ElMessage } from "element-plus";
import musicRequest from '@/utils/musicRequest';
import { handleWord } from '@/utils/handleWord';
import { shareToQQ, shareToWeChat, shareToWebo } from '@/utils/share/share';
import { fullScreen, requestFullScreen, smallScreen } from '@/utils/fullScreen/index';
import { handleScroll } from '@/utils/scroll/index';
const url = 'http://81.69.234.69:8000';
const persons = ref(0);
const msg = ref('');
const userinfo = store.getters.getUserInfo;
const changeFull = ref(true);
const dialogVisible = ref(false);
const roomVisible = ref(true);
const MdialogVisible = ref(false);
const router = new useRouter();
const param = reactive({
  /*ÂàÜ‰∫´Âú∞ÂùÄ*/
  desc: '![http://localhost:3000/chat](ÁÇπÂáªËøõÂÖ•)',
  /*ÂàÜ‰∫´ÁêÜÁî±(ÂèØÈÄâ)*/
  title: 'Â∞èÂûãÂ®±‰πêÂπ≥Âè∞ÔºåÂø´Êù•ÂíåÊàë‰∏ÄËµ∑ËæπÂê¨ËæπËÅä~',
  /*ÂàÜ‰∫´Ê†áÈ¢ò(ÂèØÈÄâ)*/
  summary: 'Âø´Êù•ÂíåÊàë‰∏ÄËµ∑ËæπÂê¨ËæπËÅä',
  /*ÂàÜ‰∫´ÊèèËø∞(ÂèØÈÄâ)*/
  /*ÂàÜ‰∫´ÂõæÁâá(ÂèØÈÄâ)*/
  /*ËßÜÈ¢ëÂú∞ÂùÄ(ÂèØÈÄâ)*/
});
/** ÂàÜ‰∫´ */
const share = () => {
  dialogVisible.value = true;
}

/** ËøûÊé• */
const socket = io(url, {
  transports: ['websocket'],
  reconnection: true,
  reconnectionAttempts: Infinity,
  auth: {
    token: '123',
  },
  cors: true,
});
let audio = new Audio();

/** Ëé∑ÂèñÂä®ÊÄÅÊ≠åÊõ≤ ÂΩìËøõÂÖ•ÊàøÈó¥Êó∂ */
async function getDList () {

  // audio.pause();
  const id = await GetDmusicList().then((res) => {
    const value = res;
    if (!value) {
      ElMessage({
        message: "ÊöÇÊú™ÂåπÈÖçÂà∞Èü≥‰πêÔºåËØ∑Á®çÂêéÂÜçËØï",
        type: "error"
      });
      return;
    }
    const musicURL = value.split(" ")[0];
    let id = value.split(" ")[1];
    audio.src = musicURL;
    audio.play().then(() => {

    }).catch(() => {
      ElMessage({
        message: "Êí≠ÊîæÂá∫Èîô",
        type: "error"
      });
    });
    return id;
  });
  const word = await getWord(id).then((res) => {
    return res.data.lrc.lyric;
  });
  /** Ê≠åËØçÂ§ÑÁêÜ */
  handleWord(word, audio);
}
/** Ëé∑ÂèñÊ≠åËØç */
const getWord = (id) => {
  return musicRequest('get', `/lyric?id=${id}`);
}
/** Ê≠åÊõ≤ÂÅú‰∫ÜÂ∞±ÈáçÊñ∞Âä®ÊÄÅËé∑ÂèñÊ≠åÊõ≤ */
audio.addEventListener('pause', getDList());
onMounted(() => {
  socket.on('connect', function () {
    console.log('ËøûÊé•Âà∞ÊúçÂä°Âô®');
    socket.emit('name', userinfo.username, (response) => {
      persons.value = response.status;
    });
  });
  let newDiv = document.createElement('div');
  newDiv.innerHTML = 'üéâÊ¨¢Ëøé‰Ω†ËøõÂÖ•ËÅäÂ§©ÂÆ§üéâ';
  newDiv.style.display = 'flex';
  newDiv.style.justifyContent = 'center';
  document.getElementById('p').appendChild(newDiv);
  ElMessage({
    message: "Ê≥®ÊÑèÂ£∞Èü≥ÔºåÂç≥Â∞ÜÊí≠ÊîæÈü≥‰πê",
    type: "success"
  });
  getDList();
  handleScroll();

});
/** ÁõëÂê¨Ê¨¢ËøéÂπøÊí≠ */
socket.on('welcome', (result) => {
  persons.value = result.persons;
  let newDiv = document.createElement('div');
  newDiv.innerHTML = result.time + ' ' + result.msg;
  newDiv.style.display = 'flex';
  newDiv.style.justifyContent = 'center';
  document.getElementById('p').appendChild(newDiv);
});

/** ÁõëÂê¨Ê∂àÊÅØÂπøÊí≠ */
socket.on('broadcast', (result) => {
  createDialog(2, result.msg, result.username);
  document.getElementById('p').scrollTop =
    document.getElementById('p').scrollHeight;
});

/** ÁõëÂê¨Êñ≠ÂºÄËøûÊé• */
socket.on('disconnect', function () {
  console.log('ËøûÊé•Êñ≠ÂºÄ');
});

/** ÁõëÂê¨‰∫∫Á¶ªÂºÄÂπøÊí≠ */
socket.on('somebodyExit', (response) => {
  persons.value = response.status;
});

/** ÂàõÂª∫Ê∂àÊÅØ */
const createDialog = (type, data, username) => {
  let container = document.createElement('div');
  let newDiv = document.createElement('div');
  let head = document.createElement('div');
  let one = document.createElement('div');

  one.style.borderTop = '8px solid transparent';
  if (type === 1) {
    one.style.borderLeft = '8px solid #00b96b';
    one.style.borderRight = '8px solid transparent';
    newDiv.style.backgroundColor = '#00b96b';
    head.innerHTML = 'Êàë';
    container.style.justifyContent = 'flex-end';
  } else {
    one.style.borderLeft = '8px solid transparent';
    one.style.borderRight = '8px solid #eeeeee';
    newDiv.style.backgroundColor = '#eeeeee';
    head.innerHTML = username;
    container.style.justifyContent = 'flex-start';
    newDiv.style.color = 'black';
  }

  one.style.borderBottom = '8px solid transparent';
  one.style.width = '0px';
  one.style.height = '0px';

  newDiv.innerHTML = data;
  newDiv.style.padding = '10px';
  newDiv.style.borderRadius = '5px';

  container.style.display = 'flex';
  container.style.margin = '5px';
  container.style.alignItems = 'center';
  if (type === 1) {
    container.appendChild(newDiv);
    container.appendChild(one);
    container.appendChild(head);
  } else {
    container.appendChild(head);
    container.appendChild(one);
    container.appendChild(newDiv);
  }

  document.getElementById('p').appendChild(container);
};

/** Ëß¶ÂèëÂèëÈÄÅÊ∂àÊÅØ */
const send = () => {
  if (msg.value == '\n' || msg.value == '\n\n') {
    msg.value = '';
    return;
  }
  createDialog(1, msg.value);
  socket.emit('send', { data: msg.value, username: userinfo.username });
  msg.value = '';
};

/** Ëß¶ÂèëÁ¶ªÂºÄÊåâÈíÆ */
const close = () => {
  socket.emit('exit', { username: userinfo.username });
  roomVisible.value = false;
  audio.pause();
};

/** ÂÜçÊ¨°ËøõÂÖ•ËÅäÂ§©ÂÆ§ */
const enteragain = () => {
  roomVisible.value = true;
  audio.play();
}
/** ÁÇπÊ≠å */
const pickMusic = () => {
  // MdialogVisible.value = true;
  router.push("/archive");
}

/** È°µÈù¢Âà∑Êñ∞ */
window.onbeforeunload = (to, from, next) => {
  socket.emit('exit', { username: userinfo.username });
}
/** ÈîÄÊØÅ‰πãÂâç */
onBeforeUnmount(() => {
  audio.pause();
  socket.emit('exit', { username: userinfo.username });
})
/** ÂàáÊç¢Ë∑ØÁî±Êó∂ÂÅúÊ≠¢Èü≥‰πêÁöÑÊí≠Êîæ */
// onBeforeRouteLeave(() => {
  // console.log('Áß¶Êµ∑ÁíêÊúâ')
  // socket.emit('exit', { username: userinfo.username });
  // audio.pause();
  // next();
// })
</script>
<style scoped>
.share {
  display: flex;
  justify-content: space-around;
}
a {
  text-decoration: none;
  cursor: pointer;
  color: #2c3e50;
  padding: 5px;
}
.container {
  display: flex;
  justify-content: center;
  color: black;
}
.chatRoom {
  height: 90vh;
  width: 100%;
  display: flex;
  background-color: black;
}
.background {
  width: 70vw;
  height: 80%;
  background-color: white;
  border-radius: 20px;
  padding: 5px;
  margin: auto;
  box-shadow: var(--message-panel-box-shadow, 0 0 15px #f2f2f2);
}

.banner {
  width: 100%;
  height: 7%;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
}

span {
  padding: 0 5px 0 5px;
}
a:hover {
  background-color: #e0dede;
  border-radius: 0.5em 0.5em 0.5em;
}

.main {
  width: 100%;
  height: 93%;
  line-height: 20px;
  position: relative;
}
.textareaBanner {
  border-top: 1px solid black;
  height: 7%;
  background-color: white;
  display: flex;
  /* box-sizing: border-box; */
  padding: 5px 0 3px 0;
}
.textarea {
  width: 100%;
  height: 18%;
  padding: 0;
  border: 0;
  outline: none;
  /* background-color: black; */
  border-radius: 0 0 20px 20px;
  outline: none;
  border: none;
  resize: none;
  /* color: white; */
}

#lyric {
  position: absolute;
  bottom: 0;
  margin: 0 0 0 10px;
  font-size: 14px;
}

#p {
  /* background-color: black; */
  width: 100%;
  height: 75%;
  /* overflow: scroll; */
  overflow-y: scroll;
  max-height: 75%;
}
</style>